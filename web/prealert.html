<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PRM Pre-Alerts — Management</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 14px;
      color: #111;
      background: #f5f5f5;
      padding: 10px 14px;
    }

    /* ── Toolbar ──────────────────────────────── */
    .topbar {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      padding: 8px 10px; background: #fff; border-radius: 10px;
      border: 1px solid #e1e1e1; margin-bottom: 10px;
    }
    .topbar button {
      padding: 5px 14px; font-size: 13px; cursor: pointer;
      border: 1px solid #ccc; border-radius: 6px; background: #fff;
    }
    .topbar button:hover { background: #eee; }
    .topbar button.primary { background: #1a73e8; color: #fff; border-color: #1a73e8; }
    .topbar button.primary:hover { background: #155bb5; }

    .filters { display: flex; gap: 4px; align-items: center; }
    .pill {
      padding: 4px 12px; border-radius: 999px; border: 1px solid #ccc;
      background: #fff; font-size: 12px; cursor: pointer;
    }
    .pill:hover { background: #f0f0f0; }
    .pill.active { background: #111; color: #fff; border-color: #111; }

    .filters label { font-size: 12px; color: #555; }
    .filters select {
      padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc;
      font-size: 12px;
    }

    .searchWrap input {
      padding: 5px 10px; border: 1px solid #ccc; border-radius: 6px;
      font-size: 13px; width: 160px;
    }

    .meta { font-size: 11px; color: #888; margin-left: auto; white-space: nowrap; }

    /* ── Error ────────────────────────────────── */
    .err { color: #b00020; font-weight: bold; padding: 4px 10px; display: none; }
    .err.show { display: block; }

    /* ── KPI Summary ─────────────────────────── */
    .summary {
      display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px;
    }
    .kpi {
      background: #fff; border: 1px solid #e1e1e1; border-radius: 10px;
      padding: 10px 16px; text-align: center; min-width: 120px;
    }
    .kpi .label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi .value { font-size: 26px; font-weight: 700; margin-top: 2px; }
    .kpi .value.wchr { color: #1a73e8; }
    .kpi .value.wchc { color: #e67e22; }
    .kpi .value.prm  { color: #c0392b; }
    .kpi .value.flt  { color: #27ae60; }

    /* ── Panels ──────────────────────────────── */
    .panel {
      background: #fff; border: 1px solid #e1e1e1; border-radius: 10px;
      overflow: hidden; margin-bottom: 14px;
    }
    .panel h3 {
      font-size: 13px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 8px 12px; background: #fafafa;
      border-bottom: 1px solid #e1e1e1; color: #444;
    }
    .panel .chart-wrap {
      padding: 12px 14px;
      position: relative;
    }

    /* ── Bottom Row: bar chart + top 10 ──────── */
    .bottom-row {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 14px;
      margin-bottom: 14px;
    }
    @media (max-width: 900px) {
      .bottom-row { grid-template-columns: 1fr; }
    }

    /* ── Top 10 Table ────────────────────────── */
    #top10 {
      width: 100%; border-collapse: collapse; font-size: 13px;
    }
    #top10 th {
      background: #f7f7f7; font-size: 11px; text-transform: uppercase;
      padding: 6px 8px; border-bottom: 2px solid #ddd;
      text-align: left; white-space: nowrap;
    }
    #top10 td {
      padding: 6px 8px; border-bottom: 1px solid #f0f0f0;
      white-space: nowrap;
    }
    #top10 .rank { font-weight: 800; color: #888; width: 28px; text-align: center; }
    #top10 .flt { font-weight: 700; }
    #top10 .arr { color: #155724; }
    #top10 .dep { color: #1a4d8f; }
    #top10 .cnt { font-weight: 700; text-align: center; }
    #top10 .cnt-hi { font-weight: 700; text-align: center; color: #c00; }

    /* ── Print ────────────────────────────────── */
    @media print {
      body { background: #fff; padding: 0; }
      .topbar { display: none !important; }
      .login-overlay { display: none !important; }
      .panel { break-inside: avoid; border: 1px solid #ccc; }
    }

    /* ── Loading ──────────────────────────────── */
    #loading { text-align: center; padding: 40px; font-size: 14px; color: #666; }

    /* ── Login Overlay ───────────────────────── */
    .login-overlay {
      position: fixed; inset: 0; z-index: 100;
      background: linear-gradient(135deg, #0a0e1a, #141b33);
      display: flex; align-items: center; justify-content: center;
    }
    .login-box {
      background: rgba(15,22,48,0.85); border: 1px solid #1d2a55;
      border-radius: 16px; padding: 28px 24px; width: min(400px, 90%);
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
      color: #eaf0ff;
    }
    .login-box h2 { font-size: 18px; margin-bottom: 4px; }
    .login-box .sub { font-size: 12px; color: #7f8cc3; margin-bottom: 16px; }
    .login-box label { display: block; font-size: 12px; color: #aab7e6; margin-bottom: 4px; }
    .login-box input {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #1d2a55; background: rgba(7,10,18,0.4);
      color: #eaf0ff; margin-bottom: 12px; outline: none;
    }
    .login-box input:focus { border-color: #7c5cff; box-shadow: 0 0 0 3px rgba(124,92,255,.2); }
    .login-box button {
      width: 100%; padding: 11px; border-radius: 10px; border: none;
      background: linear-gradient(135deg, #7c5cff, #00d4ff);
      color: #081022; font-weight: 700; font-size: 14px; cursor: pointer;
    }
    .login-box button:hover { filter: brightness(1.05); }
    .login-box button:disabled { opacity: 0.6; cursor: not-allowed; }
    .login-box .login-err {
      color: #ffd0d9; background: rgba(255,77,109,.12);
      border: 1px solid rgba(255,77,109,.3); padding: 8px 10px;
      border-radius: 8px; font-size: 12px; margin-bottom: 10px;
    }
    .login-box .login-err:empty { display: none; }
  </style>
</head>
<body>

  <!-- Login overlay (mgmt only) -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>Management Pre-Alerts</h2>
      <div class="sub">Mgmt-level access required</div>
      <div class="login-err" id="loginErr"></div>
      <label for="loginUser">Username</label>
      <input id="loginUser" placeholder="Username" autocomplete="username" />
      <label for="loginPin">PIN</label>
      <input id="loginPin" placeholder="PIN" type="password" inputmode="numeric" autocomplete="current-password" />
      <button id="loginBtn" onclick="doLogin()">Login</button>
    </div>
  </div>

  <div class="topbar">
    <button class="primary" onclick="manualRefresh()">Refresh</button>
    <button onclick="window.print()">Print</button>
    <button onclick="window.close()">Close</button>

    <div class="filters">
      <label>Bucket
        <select id="bucketSize" onchange="onBucketChange()">
          <option value="5">5 min</option>
          <option value="10">10 min</option>
          <option value="15" selected>15 min</option>
          <option value="30">30 min</option>
          <option value="60">60 min</option>
        </select>
      </label>
    </div>

    <div class="filters" id="zonePills">
      <button class="pill active" onclick="setZone('ALL')">All Zones</button>
      <button class="pill" onclick="setZone('TB')">TB</button>
      <button class="pill" onclick="setZone('Gates')">Gates</button>
      <button class="pill" onclick="setZone('Pier A')">Pier A</button>
      <button class="pill" onclick="setZone('T1')">T1</button>
      <button class="pill" onclick="setZone('Unassigned')">Unasgn</button>
    </div>

    <div class="filters" id="typePills">
      <button class="pill active" onclick="setType('ALL')">All</button>
      <button class="pill" onclick="setType('ARR')">ARR</button>
      <button class="pill" onclick="setType('DEP')">DEP</button>
    </div>

    <div class="searchWrap">
      <input id="q" placeholder="Search flight..." oninput="onSearch()" />
    </div>

    <span class="meta" id="lastRefresh"></span>
  </div>

  <div id="err" class="err"></div>

  <div class="summary" id="summary"></div>

  <div id="loading">Loading flight data...</div>

  <div id="content" style="display:none;">

    <!-- Big line chart: full width -->
    <div class="panel">
      <h3>PRM Demand Timeline — Plan Time (03:00 → 02:59)</h3>
      <div class="chart-wrap">
        <canvas id="lineChart" height="280"></canvas>
      </div>
    </div>

    <!-- Bottom row: zone bar chart + top 10 -->
    <div class="bottom-row">
      <div class="panel">
        <h3>Traffic by Zone</h3>
        <div class="chart-wrap">
          <canvas id="zoneBar" height="260"></canvas>
        </div>
      </div>
      <div class="panel">
        <h3>Top 10 Heaviest Flights</h3>
        <div style="overflow:auto; max-height: 340px;">
          <table id="top10">
            <thead>
              <tr>
                <th>#</th><th>Flight</th><th>Type</th>
                <th>Plan</th><th>Est</th><th>Gate</th><th>Zone</th>
                <th>WR</th><th>WC</th><th>Total</th>
              </tr>
            </thead>
            <tbody id="top10Body"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="/config.js"></script>
  <script>
    /* ── Config ──────────────────────────────── */
    const API_BASE = (window.PRM_CONFIG && window.PRM_CONFIG.API_BASE) || "";
    const LS_TOKEN = "PRM_TOKEN";
    const REFRESH_MS = 30000;
    const ZONES = ["TB", "Gates", "Pier A", "T1", "Unassigned"];

    /* ── State ───────────────────────────────── */
    let allRows = [];
    let filterType = "ALL";
    let filterZone = "ALL";
    let bucketMin = 15;
    let searchQ = "";
    let pollTimer = null;
    let lineChartObj = null;
    let zoneBarObj = null;

    const ZONE_COLORS = {
      "TB":         { bg: "rgba(52,152,219,0.75)",  border: "#2980b9" },
      "Gates":      { bg: "rgba(46,204,113,0.75)",  border: "#27ae60" },
      "Pier A":     { bg: "rgba(155,89,182,0.75)",  border: "#8e44ad" },
      "T1":         { bg: "rgba(230,126,34,0.75)",  border: "#d35400" },
      "Unassigned": { bg: "rgba(149,165,166,0.75)", border: "#7f8c8d" },
    };

    /* ── Auth ─────────────────────────────────── */
    function getToken() { return localStorage.getItem(LS_TOKEN) || ""; }

    /* ── Toronto time helpers ─────────────────── */
    const TZ = "America/Toronto";
    const timeFmt = new Intl.DateTimeFormat("en-CA", {
      timeZone: TZ, hour: "2-digit", minute: "2-digit", hour12: false,
    });

    function fmtTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      return isNaN(d.getTime()) ? String(iso) : timeFmt.format(d);
    }

    function toTorontoHM(d) {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: TZ, hour: "numeric", minute: "numeric", hour12: false,
      }).formatToParts(d);
      let h = 0, m = 0;
      for (const p of parts) {
        if (p.type === "hour") h = parseInt(p.value, 10);
        if (p.type === "minute") m = parseInt(p.value, 10);
      }
      return { h, m };
    }

    function esc(s) {
      return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    /* ── Plan time calculation ────────────────── */
    function computePlanTime(row) {
      const est = new Date(row.timeEst);
      if (isNaN(est.getTime())) return null;
      if (row.type === "DEP") {
        const dest = (row.origin || "").trim().toUpperCase();
        const offsetMin = dest.charAt(0) === "Y" ? 60 : 90;
        return new Date(est.getTime() - offsetMin * 60000);
      }
      return est;
    }

    /* ── Bucketing ────────────────────────────── */
    function getBucketKey(planDate) {
      const { h, m } = toTorontoHM(planDate);
      const totalMin = h * 60 + m;
      const bucketStart = Math.floor(totalMin / bucketMin) * bucketMin;
      const bh = Math.floor(bucketStart / 60) % 24;
      const bm = bucketStart % 60;
      return String(bh).padStart(2, "0") + ":" + String(bm).padStart(2, "0");
    }

    function generateBucketKeys() {
      const keys = [];
      for (let offset = 0; offset < 1440; offset += bucketMin) {
        let totalMin = 180 + offset; // 03:00 = 180
        if (totalMin >= 1440) totalMin -= 1440;
        const hh = String(Math.floor(totalMin / 60)).padStart(2, "0");
        const mm = String(totalMin % 60).padStart(2, "0");
        keys.push(hh + ":" + mm);
      }
      return keys;
    }

    /* ── Data processing ─────────────────────── */
    function processData() {
      const enriched = [];
      let totalWCHR = 0, totalWCHC = 0;

      for (const r of allRows) {
        const wchr = parseInt(r.wchr, 10) || 0;
        const wchc = parseInt(r.wchc, 10) || 0;
        const prm = wchr + wchc;
        if (prm <= 0) continue;

        const planTime = computePlanTime(r);
        if (!planTime) continue;

        enriched.push({
          planTime,
          planStr: fmtTime(planTime.toISOString()),
          estStr: fmtTime(r.timeEst),
          flight: r.flight || "",
          type: r.type || "",
          gate: r.gate || "",
          zone: r.zone || "Unassigned",
          wchr, wchc, prm,
          bucketKey: getBucketKey(planTime),
        });
      }

      // Apply filters
      let filtered = enriched;
      if (filterType !== "ALL")
        filtered = filtered.filter(r => r.type === filterType);
      if (filterZone !== "ALL")
        filtered = filtered.filter(r => r.zone === filterZone);
      if (searchQ) {
        const q = searchQ.toUpperCase().replace(/\s+/g, "");
        filtered = filtered.filter(r => r.flight.toUpperCase().replace(/\s+/g, "").includes(q));
      }

      // KPIs
      for (const r of filtered) {
        totalWCHR += r.wchr;
        totalWCHC += r.wchc;
      }

      // Heatmap aggregation: bucketKey → total PRM
      const bucketTotals = new Map();
      for (const r of filtered) {
        bucketTotals.set(r.bucketKey, (bucketTotals.get(r.bucketKey) || 0) + r.prm);
      }

      // Zone totals
      const zoneTotals = {};
      for (const z of ZONES) zoneTotals[z] = 0;
      for (const r of filtered) {
        zoneTotals[r.zone] = (zoneTotals[r.zone] || 0) + r.prm;
      }

      // Top 10 heaviest flights
      const top10 = [...filtered].sort((a, b) => b.prm - a.prm).slice(0, 10);

      // Sort all by plan time
      filtered.sort((a, b) => a.planTime.getTime() - b.planTime.getTime());

      return {
        kpi: { totalWCHR, totalWCHC, totalPRM: totalWCHR + totalWCHC, flights: filtered.length },
        bucketTotals,
        zoneTotals,
        top10,
      };
    }

    /* ── Render ──────────────────────────────── */
    function render() {
      const { kpi, bucketTotals, zoneTotals, top10 } = processData();

      // KPIs
      document.getElementById("summary").innerHTML = `
        <div class="kpi"><div class="label">WCHR</div><div class="value wchr">${kpi.totalWCHR}</div></div>
        <div class="kpi"><div class="label">WCHC</div><div class="value wchc">${kpi.totalWCHC}</div></div>
        <div class="kpi"><div class="label">Total PRM</div><div class="value prm">${kpi.totalPRM}</div></div>
        <div class="kpi"><div class="label">Flights</div><div class="value flt">${kpi.flights}</div></div>
      `;

      // Line chart
      renderLineChart(bucketTotals);

      // Zone bar chart
      renderZoneBar(zoneTotals);

      // Top 10 table
      renderTop10(top10);
    }

    /* ── Line Chart: PRM over time ───────────── */
    function renderLineChart(bucketTotals) {
      const allKeys = generateBucketKeys();
      // Only include range from first to last bucket with data
      let firstIdx = -1, lastIdx = -1;
      for (let i = 0; i < allKeys.length; i++) {
        if (bucketTotals.has(allKeys[i])) {
          if (firstIdx < 0) firstIdx = i;
          lastIdx = i;
        }
      }

      let labels, data;
      if (firstIdx < 0) {
        labels = allKeys;
        data = allKeys.map(() => 0);
      } else {
        // Include 1 bucket padding on each side for visual breathing room
        const start = Math.max(0, firstIdx - 1);
        const end = Math.min(allKeys.length - 1, lastIdx + 1);
        labels = allKeys.slice(start, end + 1);
        data = labels.map(k => bucketTotals.get(k) || 0);
      }

      if (lineChartObj) lineChartObj.destroy();
      const ctx = document.getElementById("lineChart").getContext("2d");
      lineChartObj = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "PRM Count",
            data,
            borderColor: "#c0392b",
            backgroundColor: "rgba(192,57,43,0.08)",
            borderWidth: 2.5,
            pointRadius: 3,
            pointBackgroundColor: "#c0392b",
            pointHoverRadius: 6,
            fill: true,
            tension: 0.25,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => "Plan Time: " + items[0].label,
                label: (item) => "PRM: " + item.formattedValue,
              },
            },
          },
          scales: {
            x: {
              ticks: { font: { size: 11 }, maxRotation: 45, autoSkip: true, maxTicksLimit: 40 },
              title: { display: true, text: "Plan Time (Toronto)", font: { size: 12, weight: "bold" } },
              grid: { color: "rgba(0,0,0,0.04)" },
            },
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1, font: { size: 11 } },
              title: { display: true, text: "PRM Count", font: { size: 12, weight: "bold" } },
              grid: { color: "rgba(0,0,0,0.06)" },
            },
          },
        },
      });
    }

    /* ── Zone Bar Chart ──────────────────────── */
    function renderZoneBar(zoneTotals) {
      const activeZones = ZONES.filter(z => zoneTotals[z] > 0);
      const labels = activeZones.length ? activeZones : ZONES;
      const data = labels.map(z => zoneTotals[z] || 0);
      const bgColors = labels.map(z => (ZONE_COLORS[z] || { bg: "#999" }).bg);
      const borderColors = labels.map(z => (ZONE_COLORS[z] || { border: "#666" }).border);

      if (zoneBarObj) zoneBarObj.destroy();
      const ctx = document.getElementById("zoneBar").getContext("2d");
      zoneBarObj = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "PRM",
            data,
            backgroundColor: bgColors,
            borderColor: borderColors,
            borderWidth: 1.5,
            borderRadius: 4,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: "y",
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { stepSize: 1, font: { size: 11 } },
              title: { display: true, text: "PRM Count", font: { size: 11 } },
              grid: { color: "rgba(0,0,0,0.05)" },
            },
            y: {
              ticks: { font: { size: 12, weight: "bold" } },
              grid: { display: false },
            },
          },
        },
      });
    }

    /* ── Top 10 Table ────────────────────────── */
    function renderTop10(top10) {
      let html = "";
      if (!top10.length) {
        html = `<tr><td colspan="10" style="padding:16px;color:#888;text-align:center;">No pre-alerts found</td></tr>`;
      } else {
        for (let i = 0; i < top10.length; i++) {
          const r = top10[i];
          const typeCls = r.type === "ARR" ? "arr" : "dep";
          const totCls = r.prm >= 10 ? "cnt-hi" : "cnt";
          html += `<tr>
            <td class="rank">${i + 1}</td>
            <td class="flt">${esc(r.flight)}</td>
            <td class="${typeCls}">${esc(r.type)}</td>
            <td>${esc(r.planStr)}</td>
            <td>${esc(r.estStr)}</td>
            <td>${esc(r.gate)}</td>
            <td>${esc(r.zone)}</td>
            <td class="cnt">${r.wchr}</td>
            <td class="cnt">${r.wchc}</td>
            <td class="${totCls}">${r.prm}</td>
          </tr>`;
        }
      }
      document.getElementById("top10Body").innerHTML = html;
    }

    /* ── Filter handlers ─────────────────────── */
    function setType(t) {
      filterType = t;
      syncPills("typePills", t);
      render();
    }

    function setZone(z) {
      filterZone = z;
      syncPills("zonePills", z);
      render();
    }

    function syncPills(containerId, activeVal) {
      const btns = document.getElementById(containerId).querySelectorAll(".pill");
      btns.forEach(b => {
        const btnVal = b.getAttribute("onclick").match(/'([^']+)'/)?.[1] || "";
        b.classList.toggle("active", btnVal === activeVal);
      });
    }

    function onBucketChange() {
      bucketMin = parseInt(document.getElementById("bucketSize").value, 10) || 15;
      render();
    }

    function onSearch() {
      searchQ = document.getElementById("q").value.trim();
      render();
    }

    /* ── Login & Auth ────────────────────────── */
    function showLogin() {
      document.getElementById("loginOverlay").style.display = "flex";
    }
    function hideLogin() {
      document.getElementById("loginOverlay").style.display = "none";
    }
    function setLoginErr(msg) {
      document.getElementById("loginErr").textContent = msg || "";
    }

    async function doLogin() {
      setLoginErr("");
      const u = (document.getElementById("loginUser").value || "").trim();
      const p = (document.getElementById("loginPin").value || "").trim();
      if (!u || !p) { setLoginErr("Enter username and PIN."); return; }

      document.getElementById("loginBtn").disabled = true;
      try {
        const res = await fetch(API_BASE + "/auth/login", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ username: u, pin: p }),
        });
        const data = await res.json();
        document.getElementById("loginBtn").disabled = false;

        if (!data || !data.ok) { setLoginErr(data?.error || "Login failed."); return; }

        if (!data.access || !data.access.mgmt) {
          setLoginErr("Access denied. Management role required.");
          return;
        }

        localStorage.setItem(LS_TOKEN, data.token);
        localStorage.setItem("PRM_USER", JSON.stringify(data.user || {}));
        hideLogin();
        startApp();
      } catch (e) {
        document.getElementById("loginBtn").disabled = false;
        setLoginErr(e.message || String(e));
      }
    }

    document.getElementById("loginUser").addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });
    document.getElementById("loginPin").addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });

    async function validateSession() {
      const token = getToken();
      if (!token) return false;
      try {
        const res = await fetch(API_BASE + "/auth/validate?app=mgmt", {
          headers: { "authorization": "Bearer " + token },
        });
        const data = await res.json();
        return data && data.ok;
      } catch { return false; }
    }

    /* ── Data loading ────────────────────────── */
    async function loadData() {
      const token = getToken();
      if (!token) { showLogin(); return; }

      try {
        const url = new URL(API_BASE + "/dispatch/rows");
        url.searchParams.set("from", "03:00");
        url.searchParams.set("opsDay", "current");

        const res = await fetch(url.toString(), {
          headers: { "authorization": "Bearer " + token },
        });
        const data = await res.json();

        if (!data || !data.ok) {
          if ((data?.error || "").includes("expired") || (data?.error || "").includes("Unauthorized")) {
            showLogin();
            return;
          }
          showErr(data?.error || "Failed to load data.");
          return;
        }

        hideErr();
        allRows = data.rows || [];

        document.getElementById("loading").style.display = "none";
        document.getElementById("content").style.display = "block";
        document.getElementById("lastRefresh").textContent =
          "Updated: " + fmtTime(new Date().toISOString());

        render();
      } catch (e) {
        showErr("Error: " + (e.message || e));
      }
    }

    function showErr(msg) {
      const el = document.getElementById("err");
      el.textContent = msg; el.classList.add("show");
    }
    function hideErr() {
      const el = document.getElementById("err");
      el.textContent = ""; el.classList.remove("show");
    }

    function manualRefresh() { loadData(); }

    function startApp() {
      loadData();
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(loadData, REFRESH_MS);
    }

    /* ── Init ─────────────────────────────────── */
    (async function boot() {
      const valid = await validateSession();
      if (valid) {
        hideLogin();
        startApp();
      } else {
        showLogin();
      }
    })();
  </script>
</body>
</html>
