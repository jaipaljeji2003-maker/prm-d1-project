<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WINGS Archive</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, Helvetica, sans-serif; font-size: 14px;
      color: #111; background: #f5f5f5; padding: 10px 14px;
    }

    /* ── Toolbar ──────────────────────────────── */
    .topbar {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      padding: 8px 10px; background: #fff; border-radius: 10px;
      border: 1px solid #e1e1e1; margin-bottom: 10px;
    }
    .topbar button, .topbar select {
      padding: 5px 14px; font-size: 13px; cursor: pointer;
      border: 1px solid #ccc; border-radius: 6px; background: #fff;
    }
    .topbar button:hover { background: #eee; }
    .topbar button.primary { background: #1a73e8; color: #fff; border-color: #1a73e8; }
    .topbar button.primary:hover { background: #155bb5; }
    .filters { display: flex; gap: 4px; align-items: center; }
    .filters label { font-size: 12px; color: #555; }
    .pill {
      padding: 4px 12px; border-radius: 999px; border: 1px solid #ccc;
      background: #fff; font-size: 12px; cursor: pointer;
    }
    .pill:hover { background: #f0f0f0; }
    .pill.active { background: #111; color: #fff; border-color: #111; }
    .meta { font-size: 11px; color: #888; margin-left: auto; white-space: nowrap; }

    /* ── Search ───────────────────────────────── */
    .search-box {
      display: flex; align-items: center; gap: 6px;
    }
    .search-box input {
      padding: 5px 10px; border: 1px solid #ccc; border-radius: 6px;
      font-size: 13px; width: 220px;
    }
    .search-hint {
      font-size: 10px; color: #aaa;
    }

    /* ── KPIs ─────────────────────────────────── */
    .summary { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .kpi {
      background: #fff; border: 1px solid #e1e1e1; border-radius: 10px;
      padding: 10px 16px; text-align: center; min-width: 100px;
      transition: box-shadow 0.15s ease;
    }
    .kpi:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .kpi.kpi-tot  { border-left: 4px solid #555; }
    .kpi.kpi-wchr { border-left: 4px solid #1a73e8; }
    .kpi.kpi-wchc { border-left: 4px solid #e67e22; }
    .kpi.kpi-prm  { border-left: 4px solid #c0392b; }
    .kpi.kpi-flt  { border-left: 4px solid #27ae60; }
    .kpi .label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi .value { font-size: 24px; font-weight: 700; margin-top: 2px; }
    .kpi .value.wchr { color: #1a73e8; }
    .kpi .value.wchc { color: #e67e22; }
    .kpi .value.prm  { color: #c0392b; }
    .kpi .value.flt  { color: #27ae60; }
    .kpi .value.tot  { color: #333; }
    .kpi .sub { font-size: 10px; color: #aaa; margin-top: 2px; }

    /* ── Column Picker ───────────────────────── */
    .col-picker {
      display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;
      padding: 8px 10px; background: #fff; border: 1px solid #e1e1e1; border-radius: 10px;
    }
    .col-picker span { font-size: 11px; color: #888; font-weight: 700; text-transform: uppercase; margin-right: 4px; align-self: center; }
    .col-tag {
      padding: 3px 10px; border-radius: 999px; border: 1px solid #ccc;
      background: #fff; font-size: 11px; cursor: pointer; user-select: none;
    }
    .col-tag:hover { background: #f0f0f0; }
    .col-tag.on { background: #1a73e8; color: #fff; border-color: #1a73e8; }

    /* ── Table ────────────────────────────────── */
    .tableWrap {
      background: #fff; border: 1px solid #e1e1e1; border-radius: 10px;
      overflow: auto; max-height: 72vh;
    }
    #tbl {
      width: 100%; border-collapse: collapse; font-size: 13px;
    }
    #tbl th {
      position: sticky; top: 0; z-index: 2;
      background: #f0f2f5; font-size: 11px; text-transform: uppercase;
      padding: 9px 12px; border-bottom: 2px solid #d0d0d0;
      border-right: 1px solid #e4e4e4;
      text-align: left; white-space: nowrap; cursor: pointer;
      user-select: none;
    }
    #tbl th:last-child { border-right: none; }
    #tbl th:hover { background: #e4e8ee; }
    #tbl th .sort-arrow { font-size: 10px; margin-left: 3px; color: #aaa; }
    #tbl td {
      padding: 8px 12px; border-bottom: 1px solid #e8e8e8;
      border-right: 1px solid #f0f0f0;
      white-space: nowrap;
    }
    #tbl td:last-child { border-right: none; }

    /* Zebra striping */
    #tbl tbody tr:nth-child(odd)  { background: #fff; }
    #tbl tbody tr:nth-child(even) { background: #f9fafb; }
    #tbl tbody tr:hover { background: #edf2fa; transition: background 0.15s ease; }

    /* Sticky first column */
    #tbl th:first-child, #tbl td:first-child {
      position: sticky; left: 0; z-index: 3;
      background: inherit; box-shadow: 2px 0 4px rgba(0,0,0,0.06);
    }
    #tbl th:first-child { z-index: 4; background: #f0f2f5; }
    #tbl tbody tr:hover td:first-child { background: #edf2fa; }

    /* Column emphasis */
    #tbl .flt { font-weight: 700; color: #1a1a2e; letter-spacing: 0.02em; }
    #tbl .arr { color: #155724; }
    #tbl .dep { color: #1a4d8f; }
    #tbl .cnt { font-weight: 700; text-align: center; color: #1a73e8; }
    #tbl .cnt-hi { font-weight: 700; text-align: center; color: #fff; background: #c0392b; border-radius: 4px; }
    #tbl tr.match-hl { background: #fffde7; }

    .err { color: #b00020; font-weight: bold; padding: 4px 10px; display: none; }
    .err.show { display: block; }
    #loading { text-align: center; padding: 40px; font-size: 14px; color: #666; }

    /* ── Print ────────────────────────────────── */
    @media print {
      body { background: #fff; padding: 0; }
      .topbar, .col-picker, .login-overlay { display: none !important; }
      #tbl tbody tr:nth-child(even) { background: #f5f5f5 !important; }
      #tbl td, #tbl th { border-right: 1px solid #ddd !important; }
      #tbl th:first-child, #tbl td:first-child { position: static; box-shadow: none; }
    }

    /* ── Login ────────────────────────────────── */
    .login-overlay {
      position: fixed; inset: 0; z-index: 100;
      background: linear-gradient(135deg, #0a0e1a, #141b33);
      display: flex; align-items: center; justify-content: center;
    }
    .login-box {
      background: rgba(15,22,48,0.85); border: 1px solid #1d2a55;
      border-radius: 16px; padding: 28px 24px; width: min(400px, 90%);
      box-shadow: 0 18px 55px rgba(0,0,0,.55); color: #eaf0ff;
    }
    .login-box h2 { font-size: 18px; margin-bottom: 4px; }
    .login-box .sub { font-size: 12px; color: #7f8cc3; margin-bottom: 16px; }
    .login-box label { display: block; font-size: 12px; color: #aab7e6; margin-bottom: 4px; }
    .login-box input {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #1d2a55; background: rgba(7,10,18,0.4);
      color: #eaf0ff; margin-bottom: 12px; outline: none;
    }
    .login-box input:focus { border-color: #7c5cff; box-shadow: 0 0 0 3px rgba(124,92,255,.2); }
    .login-box button {
      width: 100%; padding: 11px; border-radius: 10px; border: none;
      background: linear-gradient(135deg, #7c5cff, #00d4ff);
      color: #081022; font-weight: 700; font-size: 14px; cursor: pointer;
    }
    .login-box button:hover { filter: brightness(1.05); }
    .login-box button:disabled { opacity: 0.6; cursor: not-allowed; }
    .login-box .login-err {
      color: #ffd0d9; background: rgba(255,77,109,.12);
      border: 1px solid rgba(255,77,109,.3); padding: 8px 10px;
      border-radius: 8px; font-size: 12px; margin-bottom: 10px;
    }
    .login-box .login-err:empty { display: none; }

    /* ── WINGS Nav (inline for archive) ──────── */
    .wings-nav { display:flex; align-items:center; background:#111827; color:#fff; padding:0 16px; height:46px; margin:-10px -14px 12px -14px; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; position:sticky; top:-10px; z-index:100; box-shadow:0 2px 8px rgba(0,0,0,.15); }
    .wings-nav-brand { display:flex; align-items:center; gap:8px; margin-right:6px; padding-right:14px; border-right:1px solid rgba(255,255,255,.15); text-decoration:none; color:#fff; }
    .wings-nav-brand svg { width:26px; height:26px; flex-shrink:0; }
    .wings-nav-brand span { font-size:15px; font-weight:800; letter-spacing:2px; background:linear-gradient(135deg,#7C5CFF,#00D4FF); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .wings-nav-links { display:flex; align-items:center; gap:2px; flex:1; padding-left:6px; }
    .wings-nav-link { padding:6px 14px; border-radius:999px; font-size:13px; font-weight:600; color:rgba(255,255,255,.65); text-decoration:none; transition:background .15s,color .15s; white-space:nowrap; }
    .wings-nav-link:hover { background:rgba(255,255,255,.1); color:#fff; }
    .wings-nav-link.active { background:rgba(124,92,255,.25); color:#fff; }
    .wings-nav-right { display:flex; align-items:center; gap:10px; margin-left:auto; }
    .wings-nav-user { font-size:12px; color:rgba(255,255,255,.55); white-space:nowrap; }
    .wings-nav-logout { padding:5px 12px; border-radius:999px; font-size:12px; font-weight:600; color:rgba(255,255,255,.7); background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); cursor:pointer; transition:background .15s; text-decoration:none; }
    .wings-nav-logout:hover { background:rgba(255,77,109,.25); color:#fff; }
  </style>
</head>
<body>
  <nav class="wings-nav" id="wingsNav">
    <a href="/" class="wings-nav-brand">
      <svg viewBox="0 0 64 64" fill="none"><defs><linearGradient id="wg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#7C5CFF"/><stop offset="100%" stop-color="#00D4FF"/></linearGradient></defs><path d="M8 40C12 28 24 16 56 10C48 18 38 28 34 38C38 30 44 22 56 10C36 20 22 32 14 44L8 40Z" fill="url(#wg)" opacity=".9"/><path d="M12 46C16 36 26 26 52 20C44 28 36 36 32 44C36 38 42 30 52 20C34 30 24 40 18 50L12 46Z" fill="url(#wg)" opacity=".55"/><circle cx="32" cy="52" r="3.5" fill="url(#wg)" opacity=".7"/></svg>
      <span>WINGS</span>
    </a>
    <div class="wings-nav-links">
      <a href="/dispatch.html" class="wings-nav-link" id="navDispatch">Dispatch</a>
      <a href="/lead.html" class="wings-nav-link" id="navLead">Lead</a>
      <a href="/prealert.html" class="wings-nav-link" id="navMgmt">Pre-Alerts</a>
      <a href="/archive.html" class="wings-nav-link active">Archive</a>
    </div>
    <div class="wings-nav-right">
      <span class="wings-nav-user" id="navUser"></span>
      <a href="#" class="wings-nav-logout" onclick="localStorage.removeItem('PRM_TOKEN');localStorage.removeItem('PRM_USER');location.href='/'; return false;">Logout</a>
    </div>
  </nav>
  <script>
    (function(){
      try {
        const u = JSON.parse(localStorage.getItem("PRM_USER") || "{}");
        if (u.username) document.getElementById("navUser").textContent = u.username;
        const access = JSON.parse(localStorage.getItem("PRM_ACCESS") || "{}");
        if (!access.dispatch) { const el = document.getElementById("navDispatch"); if(el) el.style.display="none"; }
        if (!access.lead) { const el = document.getElementById("navLead"); if(el) el.style.display="none"; }
      } catch {}
    })();
  </script>

  <!-- Access Denied overlay -->
  <div class="login-overlay" id="accessDenied" style="display:none;">
    <div class="login-box" style="text-align:center;">
      <h2 style="color:#FF4D6D;">Access Denied</h2>
      <div class="sub">Management-level access required to view Archive.</div>
      <button onclick="location.href='/';" style="margin-top:14px; background:linear-gradient(135deg,#7C5CFF,#00D4FF); color:#fff; border:none;">Back to Home</button>
    </div>
  </div>

  <!-- Login -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>Archive Viewer</h2>
      <div class="sub">Mgmt-level access required</div>
      <div class="login-err" id="loginErr"></div>
      <label for="loginUser">Username</label>
      <input id="loginUser" placeholder="Username" autocomplete="username" />
      <label for="loginPin">PIN</label>
      <input id="loginPin" placeholder="PIN" type="password" inputmode="numeric" autocomplete="current-password" />
      <button id="loginBtn" onclick="doLogin()">Login</button>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="topbar">
    <button class="primary" onclick="loadRows()">Load</button>
    <button onclick="window.print()">Print</button>

    <div class="filters">
      <label>Ops Date</label>
      <select id="datePicker" onchange="onDateChange()">
        <option value="">Select date...</option>
      </select>
    </div>

    <div class="filters" id="typePills">
      <button class="pill active" onclick="setType('ALL')">All</button>
      <button class="pill" onclick="setType('ARR')">ARR</button>
      <button class="pill" onclick="setType('DEP')">DEP</button>
    </div>

    <div class="search-box">
      <input id="q" placeholder="Search: flight, gate, zone, origin..." oninput="onSearch()" />
      <span class="search-hint">multi-field fuzzy</span>
    </div>

    <span class="meta" id="metaInfo"></span>
  </div>

  <div id="err" class="err"></div>
  <div class="summary" id="summary"></div>

  <!-- Column picker -->
  <div class="col-picker" id="colPicker"></div>

  <div id="loading" style="display:none;">Loading archive...</div>

  <!-- Data table -->
  <div class="tableWrap">
    <table id="tbl">
      <thead><tr id="thead"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script src="/config.js"></script>
  <script>
    /* ── Config ──────────────────────────────── */
    const API_BASE = (window.PRM_CONFIG && window.PRM_CONFIG.API_BASE) || "";
    const LS_TOKEN = "PRM_TOKEN";
    const TZ = "America/Toronto";
    const timeFmt = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, hour: "2-digit", minute: "2-digit", hour12: false });

    /* ── All available columns ────────────────── */
    const ALL_COLS = [
      { key: "flight",       label: "Flight",     on: true,  render: (r) => r.flight || "" },
      { key: "type",         label: "Type",        on: true,  render: (r) => r.type || "" },
      { key: "time_est",     label: "Est Time",    on: true,  render: (r) => fmtT(r.time_est) },
      { key: "sched",        label: "Sched",       on: true,  render: (r) => fmtT(r.sched) },
      { key: "origin_dest",  label: "Origin/Dest", on: true,  render: (r) => r.origin_dest || "" },
      { key: "gate",         label: "Gate",         on: true,  render: (r) => r.gate || "" },
      { key: "zone_current", label: "Zone",         on: true,  render: (r) => r.zone_current || "" },
      { key: "wchr",         label: "WCHR",         on: true,  render: (r) => numOrBlank(r.wchr) },
      { key: "wchc",         label: "WCHC",         on: true,  render: (r) => numOrBlank(r.wchc) },
      { key: "comment",      label: "Comment",      on: true,  render: (r) => r.comment || "" },
      { key: "assignment",   label: "Assignment",   on: false, render: (r) => r.assignment || "" },
      { key: "pax_assisted", label: "Pax",          on: false, render: (r) => numOrBlank(r.pax_assisted) },
      { key: "watchlist",    label: "Watchlist",    on: false, render: (r) => r.watchlist === "1" ? "Y" : "" },
      { key: "gate_changed", label: "Gate Chg",     on: false, render: (r) => r.gate_changed ? "Y" : "" },
      { key: "gate_chg_from_gate", label: "Gate From", on: false, render: (r) => r.gate_chg_from_gate || "" },
      { key: "gate_chg_to_gate",   label: "Gate To",   on: false, render: (r) => r.gate_chg_to_gate || "" },
      { key: "time_changed", label: "Time Chg",    on: false, render: (r) => r.time_changed ? "Y" : "" },
      { key: "time_delta_min", label: "Time Delta", on: false, render: (r) => r.time_delta_min != null ? r.time_delta_min + "m" : "" },
      { key: "zone_changed", label: "Zone Chg",    on: false, render: (r) => r.zone_changed ? "Y" : "" },
      { key: "zone_chg_from", label: "Zone From",  on: false, render: (r) => r.zone_chg_from || "" },
      { key: "zone_chg_to",   label: "Zone To",    on: false, render: (r) => r.zone_chg_to || "" },
      { key: "alert_text",   label: "Alert",        on: false, render: (r) => r.alert_text || "" },
      { key: "key",          label: "Key",           on: false, render: (r) => r.key || "" },
    ];

    /* ── State ───────────────────────────────── */
    let allRows = [];
    let filterType = "ALL";
    let searchQ = "";
    let sortCol = "time_est";
    let sortAsc = true;

    /* ── Helpers ──────────────────────────────── */
    function getToken() { return localStorage.getItem(LS_TOKEN) || ""; }

    function fmtT(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      return isNaN(d.getTime()) ? String(iso) : timeFmt.format(d);
    }
    function numOrBlank(v) {
      const n = parseInt(v, 10);
      return (n > 0) ? String(n) : "";
    }
    function esc(s) {
      return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    /* ── Column picker ───────────────────────── */
    function buildColPicker() {
      const el = document.getElementById("colPicker");
      let html = '<span>Columns</span>';
      for (const c of ALL_COLS) {
        html += `<div class="col-tag ${c.on ? 'on' : ''}" data-key="${c.key}" onclick="toggleCol('${c.key}')">${esc(c.label)}</div>`;
      }
      el.innerHTML = html;
    }

    function toggleCol(key) {
      const col = ALL_COLS.find(c => c.key === key);
      if (col) col.on = !col.on;
      buildColPicker();
      renderTable();
    }

    function activeCols() { return ALL_COLS.filter(c => c.on); }

    /* ── Search: multi-field fuzzy ────────────── */
    function matchesSearch(row, tokens) {
      if (!tokens.length) return true;
      // Build a searchable string from all fields
      const haystack = [
        row.flight, row.type, row.origin_dest, row.gate,
        row.zone_current, row.comment, row.assignment, row.alert_text,
        fmtT(row.time_est), fmtT(row.sched),
      ].join(" ").toUpperCase().replace(/\s+/g, " ");

      // Every token must match somewhere (AND logic)
      return tokens.every(t => haystack.includes(t));
    }

    /* ── Sort ─────────────────────────────────── */
    function sortRows(rows) {
      const col = ALL_COLS.find(c => c.key === sortCol);
      if (!col) return rows;

      return [...rows].sort((a, b) => {
        let va = col.render(a);
        let vb = col.render(b);
        // Numeric sort for WCHR/WCHC/Pax/TimeDelta
        const na = parseFloat(va), nb = parseFloat(vb);
        if (!isNaN(na) && !isNaN(nb)) return sortAsc ? na - nb : nb - na;
        // String sort
        va = String(va).toUpperCase();
        vb = String(vb).toUpperCase();
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
      });
    }

    function onSort(key) {
      if (sortCol === key) { sortAsc = !sortAsc; }
      else { sortCol = key; sortAsc = true; }
      renderTable();
    }

    /* ── Filter + Render ─────────────────────── */
    function getFilteredRows() {
      let rows = allRows;
      if (filterType !== "ALL") rows = rows.filter(r => r.type === filterType);

      const tokens = searchQ.toUpperCase().replace(/\s+/g, " ").trim().split(" ").filter(Boolean);
      if (tokens.length) rows = rows.filter(r => matchesSearch(r, tokens));

      return sortRows(rows);
    }

    function renderKPIs(filtered) {
      let totalWCHR = 0, totalWCHC = 0, prmFlights = 0;
      for (const r of filtered) {
        const wr = parseInt(r.wchr, 10) || 0;
        const wc = parseInt(r.wchc, 10) || 0;
        totalWCHR += wr;
        totalWCHC += wc;
        if (wr + wc > 0) prmFlights++;
      }

      const dateVal = document.getElementById("datePicker").value;
      const dateLabel = dateVal || "—";

      document.getElementById("summary").innerHTML = `
        <div class="kpi kpi-tot">
          <div class="label">Ops Date</div>
          <div class="value tot" style="font-size:18px;">${esc(dateLabel)}</div>
          <div class="sub">03:00 → 02:59</div>
        </div>
        <div class="kpi kpi-tot"><div class="label">Total Flights</div><div class="value tot">${filtered.length}</div></div>
        <div class="kpi kpi-wchr"><div class="label">WCHR</div><div class="value wchr">${totalWCHR}</div></div>
        <div class="kpi kpi-wchc"><div class="label">WCHC</div><div class="value wchc">${totalWCHC}</div></div>
        <div class="kpi kpi-prm"><div class="label">Total PRM</div><div class="value prm">${totalWCHR + totalWCHC}</div></div>
        <div class="kpi kpi-flt"><div class="label">Flights w/ PRM</div><div class="value flt">${prmFlights}</div></div>
      `;
    }

    function renderTable() {
      const cols = activeCols();
      const filtered = getFilteredRows();

      renderKPIs(filtered);

      // Thead
      let headHtml = "";
      for (const c of cols) {
        const arrow = sortCol === c.key ? (sortAsc ? " ▲" : " ▼") : "";
        headHtml += `<th onclick="onSort('${c.key}')">${esc(c.label)}<span class="sort-arrow">${arrow}</span></th>`;
      }
      document.getElementById("thead").innerHTML = headHtml;

      // Tbody
      const tokens = searchQ.toUpperCase().replace(/\s+/g, " ").trim().split(" ").filter(Boolean);
      let bodyHtml = "";
      if (!filtered.length) {
        bodyHtml = `<tr><td colspan="${cols.length}" style="padding:20px;color:#888;text-align:center;">No flights found</td></tr>`;
      } else {
        for (const r of filtered) {
          const isHl = tokens.length > 0;
          bodyHtml += `<tr${isHl ? ' class="match-hl"' : ''}>`;
          for (const c of cols) {
            let val = esc(c.render(r));
            let cls = "";
            if (c.key === "flight") cls = "flt";
            else if (c.key === "type") cls = r.type === "ARR" ? "arr" : "dep";
            else if (c.key === "wchr" || c.key === "wchc") {
              const n = parseInt(r[c.key], 10) || 0;
              cls = n >= 10 ? "cnt-hi" : (n > 0 ? "cnt" : "");
            }
            bodyHtml += `<td${cls ? ` class="${cls}"` : ''}>${val}</td>`;
          }
          bodyHtml += "</tr>";
        }
      }
      document.getElementById("tbody").innerHTML = bodyHtml;

      // Meta
      const total = allRows.length;
      const shown = filtered.length;
      document.getElementById("metaInfo").textContent = shown < total ? `${shown} of ${total} flights` : `${total} flights`;
    }

    /* ── Filter handlers ─────────────────────── */
    function setType(t) {
      filterType = t;
      document.querySelectorAll("#typePills .pill").forEach(b => {
        const v = b.getAttribute("onclick").match(/'([^']+)'/)?.[1] || "";
        b.classList.toggle("active", v === t);
      });
      renderTable();
    }

    function onSearch() {
      searchQ = document.getElementById("q").value;
      renderTable();
    }

    /* ── Date picker & data loading ──────────── */
    async function loadDates() {
      const token = getToken();
      const res = await fetch(API_BASE + "/archive/dates", {
        headers: { "authorization": "Bearer " + token },
      });
      const data = await res.json();
      if (!data || !data.ok) return;

      const sel = document.getElementById("datePicker");
      sel.innerHTML = '<option value="">Select ops date...</option>';
      for (const d of data.dates) {
        sel.innerHTML += `<option value="${esc(d.date)}">${esc(d.date)} (${d.flights} flights)</option>`;
      }
    }

    function onDateChange() {
      const v = document.getElementById("datePicker").value;
      if (v) loadRows();
    }

    async function loadRows() {
      const date = document.getElementById("datePicker").value;
      if (!date) return;

      const token = getToken();
      document.getElementById("loading").style.display = "block";

      try {
        const res = await fetch(API_BASE + `/archive/rows?date=${encodeURIComponent(date)}`, {
          headers: { "authorization": "Bearer " + token },
        });
        const data = await res.json();
        document.getElementById("loading").style.display = "none";

        if (!data || !data.ok) {
          showErr(data?.error || "Failed to load archive.");
          return;
        }
        hideErr();
        allRows = data.rows || [];
        sortCol = "time_est";
        sortAsc = true;
        renderTable();
      } catch (e) {
        document.getElementById("loading").style.display = "none";
        showErr("Error: " + (e.message || e));
      }
    }

    function showErr(msg) { const el = document.getElementById("err"); el.textContent = msg; el.classList.add("show"); }
    function hideErr() { const el = document.getElementById("err"); el.textContent = ""; el.classList.remove("show"); }

    /* ── Login ────────────────────────────────── */
    function showLogin() { document.getElementById("loginOverlay").style.display = "flex"; }
    function hideLogin() { document.getElementById("loginOverlay").style.display = "none"; }
    function setLoginErr(msg) { document.getElementById("loginErr").textContent = msg || ""; }

    async function doLogin() {
      setLoginErr("");
      const u = (document.getElementById("loginUser").value || "").trim();
      const p = (document.getElementById("loginPin").value || "").trim();
      if (!u || !p) { setLoginErr("Enter username and PIN."); return; }

      document.getElementById("loginBtn").disabled = true;
      try {
        const res = await fetch(API_BASE + "/auth/login", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ username: u, pin: p }),
        });
        const data = await res.json();
        document.getElementById("loginBtn").disabled = false;
        if (!data || !data.ok) { setLoginErr(data?.error || "Login failed."); return; }
        if (!data.access || !data.access.mgmt) {
          setLoginErr("Access denied. Management role required.");
          return;
        }
        localStorage.setItem(LS_TOKEN, data.token);
        localStorage.setItem("PRM_USER", JSON.stringify(data.user || {}));
        localStorage.setItem("PRM_ACCESS", JSON.stringify(data.access || {}));
        hideLogin();
        startApp();
      } catch (e) {
        document.getElementById("loginBtn").disabled = false;
        setLoginErr(e.message || String(e));
      }
    }

    document.getElementById("loginUser").addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });
    document.getElementById("loginPin").addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });

    async function validateSession() {
      const token = getToken();
      if (!token) return false;
      try {
        const storedAccess = JSON.parse(localStorage.getItem("PRM_ACCESS") || "{}");
        if (storedAccess && storedAccess.mgmt === false) {
          document.getElementById("accessDenied").style.display = "flex";
          document.getElementById("loginOverlay").style.display = "none";
          return "denied";
        }
      } catch {}
      try {
        const res = await fetch(API_BASE + "/auth/validate?app=mgmt", {
          headers: { "authorization": "Bearer " + token },
        });
        const data = await res.json();
        if (data && data.ok) return true;
        if (data && data.error && data.error.includes("denied")) {
          document.getElementById("accessDenied").style.display = "flex";
          document.getElementById("loginOverlay").style.display = "none";
          return "denied";
        }
        return false;
      } catch { return false; }
    }

    /* ── Init ─────────────────────────────────── */
    function startApp() {
      buildColPicker();
      loadDates();
      renderTable();
    }

    (async function boot() {
      const valid = await validateSession();
      if (valid === true) { hideLogin(); startApp(); }
      else if (valid === "denied") { /* Access denied overlay shown */ }
      else { showLogin(); }
    })();
  </script>
</body>
</html>
