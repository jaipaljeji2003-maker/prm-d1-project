<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WINGS Lead</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* ── Agent Sidebar ──────────────────────── */
    .page-layout { display: flex; gap: 0; }
    .agent-sidebar {
      width: 200px; min-width: 200px;
      border-right: 1px solid #e1e1e1;
      background: #fafafa;
      padding: 10px;
      border-radius: 10px 0 0 10px;
      display: flex; flex-direction: column;
      overflow-y: auto;
    }
    .agent-sidebar.collapsed { width: 36px; min-width: 36px; padding: 10px 4px; }
    .agent-sidebar.collapsed .sidebar-add,
    .agent-sidebar.collapsed .agent-list,
    .agent-sidebar.collapsed .sidebar-header h3 { display: none; }
    .sidebar-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px;
    }
    .sidebar-header h3 {
      font-size: 13px; text-transform: uppercase; color: #555;
      letter-spacing: 0.04em; margin: 0;
    }
    .sidebar-toggle {
      padding: 2px 6px; font-size: 14px; border: none;
      background: none; color: #888; cursor: pointer;
    }
    .sidebar-add { display: flex; gap: 4px; margin-bottom: 8px; }
    .sidebar-add input {
      flex: 1; padding: 6px 8px; font-size: 12px; min-width: 0;
      border: 1px solid #ccc; border-radius: 6px;
    }
    .sidebar-add button {
      padding: 6px 10px; font-size: 12px; white-space: nowrap;
      border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer;
    }
    .sidebar-add button:hover { background: #eee; }
    .agent-list { display: flex; flex-direction: column; gap: 4px; }
    .agent-tag {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 10px; background: #fff; border: 1px solid #d0d0d0;
      border-radius: 8px; font-size: 13px; cursor: grab; user-select: none;
      transition: box-shadow 0.15s, background 0.15s;
      touch-action: none; /* Prevent browser scroll/zoom during touch drag on Android/iOS */
    }
    .agent-tag:active { cursor: grabbing; }
    .agent-tag:hover { background: #f0f4ff; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .agent-tag .remove-agent {
      margin-left: 6px; cursor: pointer; color: #999;
      font-weight: 700; font-size: 14px; line-height: 1;
    }
    .agent-tag .remove-agent:hover { color: #c00; }

    /* ── Assignment Chips ───────────────────── */
    .assign-cell {
      display: flex; flex-wrap: wrap; gap: 3px; align-items: center;
      min-height: 30px; padding: 2px 4px; border-radius: 6px;
      transition: background 0.15s;
    }
    .assign-cell.drag-over {
      background: #dbeafe; outline: 2px dashed #1a73e8;
    }
    .assign-chip {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 2px 8px; background: #e8f0fe; border: 1px solid #c4d7f2;
      border-radius: 999px; font-size: 12px; color: #1a3a6b;
    }
    .assign-chip .chip-x {
      cursor: pointer; font-weight: 700; color: #888;
      font-size: 13px; line-height: 1; margin-left: 2px;
    }
    .assign-chip .chip-x:hover { color: #c00; }
    .assign-add-btn {
      cursor: pointer; color: #888; font-size: 16px;
      padding: 0 4px; line-height: 1;
    }
    .assign-add-btn:hover { color: #1a73e8; }

    /* ── Touch Drag Ghost ──────────────────── */
    .touch-drag-ghost {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      padding: 6px 14px;
      background: #e8f0fe;
      border: 2px solid #1a73e8;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #1a3a6b;
      box-shadow: 0 4px 16px rgba(0,0,0,.18);
      white-space: nowrap;
      transform: translate(-50%, -50%);
      opacity: 0.92;
    }

    /* ── Pax Stepper ────────────────────────── */
    .pax-stepper {
      display: inline-flex; align-items: center;
      border: 1px solid #cfcfcf; border-radius: 8px;
      overflow: hidden; background: #fff;
    }
    .pax-stepper button {
      width: 26px; height: 26px; border: none; border-radius: 0;
      background: #f7f7f7; font-size: 15px; font-weight: 700;
      cursor: pointer; display: flex; align-items: center;
      justify-content: center; padding: 0; color: #333;
    }
    .pax-stepper button:hover { background: #e8e8e8; }
    .pax-stepper button:first-child { border-right: 1px solid #e0e0e0; }
    .pax-stepper button:last-child { border-left: 1px solid #e0e0e0; }
    .pax-stepper .pax-value {
      width: 34px; text-align: center; font-size: 13px; font-weight: 700;
      padding: 0 2px; border: none; outline: none; background: transparent;
      -moz-appearance: textfield;
    }
    .pax-stepper .pax-value::-webkit-outer-spin-button,
    .pax-stepper .pax-value::-webkit-inner-spin-button {
      -webkit-appearance: none; margin: 0;
    }

    .main-content { flex: 1; min-width: 0; overflow: hidden; display: flex; flex-direction: column; }
    .main-content > .tableWrap { flex: 1; }

    /* ── Zone Picker Modal ─────────────────── */
    .zone-picker-overlay {
      position: fixed; inset: 0; z-index: 9000;
      background: rgba(0,0,0,.55);
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    .zone-picker-box {
      background: #fff; border-radius: 16px; padding: 28px 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      max-width: 420px; width: 90%; text-align: center;
    }
    .zone-picker-box h2 { margin: 0 0 6px; font-size: 20px; color: #111; }
    .zone-picker-box .sub { font-size: 13px; color: #666; margin-bottom: 20px; }
    .zone-picker-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .zone-pick-btn {
      padding: 18px 14px; border-radius: 12px; border: 2px solid #e1e1e1;
      background: #fafafa; font-size: 16px; font-weight: 700; color: #333;
      cursor: pointer; transition: all .15s;
    }
    .zone-pick-btn:hover { border-color: #7C5CFF; background: #f3efff; color: #7C5CFF; }

    /* ── View-Only Banner ──────────────────── */
    .view-only-banner {
      background: #fff3cd; border: 1px solid #e4d39b; border-radius: 8px;
      padding: 8px 14px; font-size: 13px; color: #856404;
      margin-top: 6px; display: none;
    }
    .view-only-banner b { font-weight: 700; }

    /* ── Working Zone Badge ─────────────────── */
    .work-zone-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 5px 12px; border-radius: 999px;
      background: #7C5CFF; color: #fff; font-size: 12px; font-weight: 700;
      white-space: nowrap;
    }
    .work-zone-change {
      padding: 3px 10px; border-radius: 999px; font-size: 11px;
      background: #f3efff; color: #7C5CFF; border: 1px solid #d4c8ff;
      cursor: pointer; font-weight: 600; transition: background .15s;
    }
    .work-zone-change:hover { background: #e8e0ff; }

    /* ── Filter Layout (two rows) ──────────── */
    .topbar-primary {
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap; padding: 8px 0 4px;
    }
    .topbar-filters {
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
      padding: 4px 0 6px; font-size: 12px;
    }
    .filter-group {
      display: flex; gap: 4px; align-items: center;
    }
    .filter-group-label {
      font-size: 11px; color: #888; font-weight: 600; text-transform: uppercase;
      letter-spacing: .04em; margin-right: 2px; white-space: nowrap;
    }
    .topbar-filters .pill { padding: 6px 12px; font-size: 12px; }
    .topbar-filters label { font-size: 12px; color: #555; }
    .topbar-filters input[type="time"] { padding: 4px 6px; font-size: 12px; }
    .topbar-filters select { padding: 4px 8px; font-size: 12px; }

    /* Working zone pill highlight */
    .pill.work-zone-pill { box-shadow: 0 0 0 2px #7C5CFF; }

    /* Read-only row dimming */
    tr.readonly-row { opacity: 0.7; }
    tr.readonly-row .assign-cell { pointer-events: none; }
  </style>
</head>
<body class="dashboard">
  <nav class="wings-nav" id="wingsNav">
    <a href="/" class="wings-nav-brand">
      <svg viewBox="0 0 64 64" fill="none"><defs><linearGradient id="wg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#7C5CFF"/><stop offset="100%" stop-color="#00D4FF"/></linearGradient></defs><path d="M8 40C12 28 24 16 56 10C48 18 38 28 34 38C38 30 44 22 56 10C36 20 22 32 14 44L8 40Z" fill="url(#wg)" opacity=".9"/><path d="M12 46C16 36 26 26 52 20C44 28 36 36 32 44C36 38 42 30 52 20C34 30 24 40 18 50L12 46Z" fill="url(#wg)" opacity=".55"/><circle cx="32" cy="52" r="3.5" fill="url(#wg)" opacity=".7"/></svg>
      <span>WINGS</span>
    </a>
    <div class="wings-nav-links">
      <a href="/dispatch.html" class="wings-nav-link" id="navDispatch">Dispatch</a>
      <a href="/lead.html" class="wings-nav-link active">Lead</a>
      <a href="/prealert.html" class="wings-nav-link" id="navMgmt">Pre-Alerts</a>
      <a href="/archive.html" class="wings-nav-link" id="navArchive">Archive</a>
    </div>
    <div class="wings-nav-right">
      <span class="wings-nav-user" id="navUser"></span>
      <a href="#" class="wings-nav-logout" onclick="logout(); return false;">Logout</a>
    </div>
  </nav>
  <script>
    (function(){
      try {
        const u = JSON.parse(localStorage.getItem("PRM_USER") || "{}");
        if (u.username) document.getElementById("navUser").textContent = u.username;
        const access = JSON.parse(localStorage.getItem("PRM_ACCESS") || "{}");
        if (!access.dispatch) { const el = document.getElementById("navDispatch"); if(el) el.style.display="none"; }
        if (!access.mgmt) { const el = document.getElementById("navMgmt"); if(el) el.style.display="none"; const el2 = document.getElementById("navArchive"); if(el2) el2.style.display="none"; }
      } catch {}
    })();
  </script>

  <div class="page-content">
  <!-- Zone Picker Modal -->
  <div class="zone-picker-overlay" id="zonePicker" style="display:none;">
    <div class="zone-picker-box">
      <h2>Select Your Working Zone</h2>
      <div class="sub">Full edit access for your zone. Other zones will be view-only.</div>
      <div class="zone-picker-grid">
        <button class="zone-pick-btn" onclick="pickWorkZone('TB')">TB</button>
        <button class="zone-pick-btn" onclick="pickWorkZone('Gates')">Gates</button>
        <button class="zone-pick-btn" onclick="pickWorkZone('Pier A')">Pier A</button>
        <button class="zone-pick-btn" onclick="pickWorkZone('T1')">T1</button>
      </div>
    </div>
  </div>

  <!-- Row 1: Primary (zone nav + search + refresh) -->
  <div class="topbar-primary">
    <span class="work-zone-badge" id="workZoneBadge">Working: —</span>
    <button class="work-zone-change" onclick="showZonePicker()">Change</button>

    <div class="filters" id="zoneControls" style="flex: 1;">
      <button class="pill active" id="zTB" onclick="setZone('TB')">TB</button>
      <button class="pill" id="zGates" onclick="setZone('Gates')">Gates</button>
      <button class="pill" id="zPierA" onclick="setZone('Pier A')">Pier A</button>
      <button class="pill" id="zT1" onclick="setZone('T1')">T1</button>
      <select id="zoneSel" onchange="onZoneDropdownChange()" style="display:none;"></select>
    </div>

    <div class="searchWrap">
      <input id="q" placeholder="Search flight..." oninput="onSearchInput()" />
    </div>
    <button onclick="manualRefresh()">Refresh</button>
  </div>

  <!-- Row 2: Filters -->
  <div class="topbar-filters">
    <div class="filter-group">
      <span class="filter-group-label">Type</span>
      <button class="pill active" id="tALL" onclick="setType('ALL')">All</button>
      <button class="pill" id="tARR" onclick="setType('ARR')">ARR</button>
      <button class="pill" id="tDEP" onclick="setType('DEP')">DEP</button>
    </div>
    <div class="filter-group">
      <span class="filter-group-label">Changes</span>
      <button class="pill active" id="cALL" onclick="setChangeFilter('ALL')">All</button>
      <button class="pill" id="cGate" onclick="setChangeFilter('GATE')">Gate</button>
      <button class="pill" id="cTime" onclick="setChangeFilter('TIME')">Time</button>
    </div>
    <div class="filter-group" id="timeWindowControl">
      <span class="filter-group-label">Time</span>
      <label>From <input type="time" id="fromTime" onchange="onTimeWindowChange()" /></label>
      <label>To <input type="time" id="toTime" onchange="onTimeWindowChange()" /></label>
      <button class="pill" onclick="clearTimeWindow()">Reset</button>
    </div>
    <div class="filter-group hidden" id="opsDayControl">
      <span class="filter-group-label">Ops Day</span>
      <select id="opsDaySelect">
        <option value="current">Current</option>
        <option value="next">Next</option>
      </select>
    </div>
  </div>

  <div class="view-only-banner" id="viewOnlyBanner"><b>View Only</b> — You are viewing <span id="viewingZoneName"></span>. Switch to your working zone to edit.</div>
  <div id="err" class="err"></div>
  <div id="loading" class="loading" style="display:none;">Loading…</div>

  <div class="summary" id="summary"></div>

  <div class="page-layout">
    <!-- Agent Sidebar -->
    <div id="agentSidebar" class="agent-sidebar">
      <div class="sidebar-header">
        <h3 id="sidebarTitle">Agents</h3>
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse">&laquo;</button>
      </div>
      <div class="sidebar-add">
        <input id="agentInput" placeholder="Agent name..." onkeydown="if(event.key==='Enter')addAgent()" />
        <button onclick="addAgent()">Add</button>
      </div>
      <div id="agentList" class="agent-list"></div>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <div class="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Watch</th><th>Flight</th><th>Type</th><th>Time</th><th>Origin/Dest</th><th>Gate</th><th>Zone</th>
              <th>WCHR</th><th>WCHC</th><th>Alert</th>
              <th>Assignment</th><th>Pax</th><th>Ack</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  </div><!-- /page-content -->

  <script src="/config.js"></script>
  <script>
    const API_BASE = (window.PRM_CONFIG && window.PRM_CONFIG.API_BASE) || "";
    const LS_TOKEN = "PRM_TOKEN";
    const LS_USER  = "PRM_USER";
    const LS_OPS_DAY = "PRM_OPS_DAY_LEAD";

    function getToken(){ return localStorage.getItem(LS_TOKEN) || ""; }
    function hardRedirectToLogin(){ window.location.href = "/"; }

    function logout(){
      localStorage.removeItem(LS_TOKEN);
      localStorage.removeItem(LS_USER);
      hardRedirectToLogin();
    }

    function resetBackoff(){ backoffMs = 0; }
    function nextBackoff(){
      backoffMs = backoffMs ? Math.min(backoffMs * 2, BACKOFF_MAX_MS) : BACKOFF_START_MS;
      return backoffMs;
    }

    function scheduleNextPoll(delay){
      if (pollTimer) clearTimeout(pollTimer);
      pollTimer = setTimeout(pollLoop, delay);
    }

    async function pollLoop(){
      const ok = await load(false);
      if (ok) resetBackoff();
      scheduleNextPoll(ok ? POLL_MS : nextBackoff());
    }

    function refreshAfterAction(){
      resetBackoff();
      if (pollTimer) clearTimeout(pollTimer);
      return load(true).finally(() => scheduleNextPoll(POLL_MS));
    }

    function manualRefresh(){
      refreshAfterAction();
    }

    async function validateAuthThenInit(){
      const token = getToken();
      if (!token) return hardRedirectToLogin();

      try {
        const res = await fetch(API_BASE + "/auth/validate?app=lead", {
          headers: { "authorization": "Bearer " + token }
        });
        const data = await res.json();
        if (!data || !data.ok) {
          localStorage.removeItem(LS_TOKEN);
          localStorage.removeItem(LS_USER);
          return hardRedirectToLogin();
        }
        await init();
        resetBackoff();
        scheduleNextPoll(POLL_MS);
      } catch {
        localStorage.removeItem(LS_TOKEN);
        localStorage.removeItem(LS_USER);
        hardRedirectToLogin();
      }
    }

    const POLL_MS = 10_000;
    const BACKOFF_START_MS = 2_000;
    const BACKOFF_MAX_MS = 15_000;

    let rows = [];
    let zonesAll = [];
    let filterType = "ALL";
    let changeFilter = "ALL";
    let selectedZone = "TB";
    let opsDayMode = "current";
    let opsDayEnabled = false;

    // ── Zone Restrictions ──
    const LS_WORK_ZONE = "PRM_LEAD_WORK_ZONE";
    let workZone = localStorage.getItem(LS_WORK_ZONE) || "";

    function isReadOnly() { return workZone && selectedZone !== workZone; }

    function showZonePicker() {
      document.getElementById("zonePicker").style.display = "flex";
    }
    function pickWorkZone(z) {
      workZone = z;
      localStorage.setItem(LS_WORK_ZONE, z);
      document.getElementById("zonePicker").style.display = "none";
      updateWorkZoneBadge();
      updateSidebarTitle();
      updateViewOnlyBanner();
      // Set selected zone to work zone and load
      selectedZone = z;
      syncZonePills_();
      syncZoneDropdown_();
      renderAgentList();
      // If first pick (page just loaded), trigger full auth+init
      if (!pollTimer) {
        validateAuthThenInit();
      } else {
        useCacheThenFetch_();
      }
    }
    function updateWorkZoneBadge() {
      const badge = document.getElementById("workZoneBadge");
      if (badge) badge.textContent = "Working: " + (workZone || "—");
    }
    function updateViewOnlyBanner() {
      const banner = document.getElementById("viewOnlyBanner");
      const nameEl = document.getElementById("viewingZoneName");
      if (!banner) return;
      if (isReadOnly()) {
        if (nameEl) nameEl.textContent = selectedZone;
        banner.style.display = "block";
      } else {
        banner.style.display = "none";
      }
      // Toggle sidebar interactivity
      const sidebar = document.getElementById("agentSidebar");
      if (sidebar) {
        sidebar.style.opacity = isReadOnly() ? "0.5" : "1";
        sidebar.style.pointerEvents = isReadOnly() ? "none" : "";
      }
    }

    let typingUntil = 0;
    const saveTimers = new Map();

    const CACHE_MS = 30000;
    const cache = new Map();

    const ackSuppress = new Map();
    const ACK_SUPPRESS_MS = 8000;
    const pendingEdits = new Map();
    const PENDING_EDIT_TTL_MS = 15_000;

    let requestSeq = 0;

    let pollTimer = null;
    let backoffMs = 0;
    let lastETag = "";  // ETag for conditional polling (304 support)

    const urlParams = new URLSearchParams(window.location.search);
    const zoneParam = urlParams.get("zone");
    const lockZone = (urlParams.get("lockZone") === "1");
    if (zoneParam) selectedZone = zoneParam;

    if (lockZone) {
      const zc = document.getElementById("zoneControls");
      if (zc) zc.classList.add("hidden");
    }

    function setErr(msg) { document.getElementById("err").textContent = msg || ""; }
    function setLoading(on) { document.getElementById("loading").style.display = on ? "block" : "none"; }

    function fmtTimeOnly(dt) {
      if (!dt) return "";
      const d = new Date(dt);
      if (isNaN(d.getTime())) return String(dt);
      return d.toLocaleTimeString(undefined, { hour:"2-digit", minute:"2-digit", hour12:false });
    }

    function normalizeFlightQ(s) { return String(s || "").toUpperCase().replace(/\s+/g, ""); }

    function getTorontoParts(date = new Date()) {
      const fmt = new Intl.DateTimeFormat("en-CA", {
        timeZone: "America/Toronto",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
      });
      const parts = Object.fromEntries(fmt.formatToParts(date).map(p => [p.type, p.value]));
      return {
        hour: Number(parts.hour),
        minute: Number(parts.minute),
        second: Number(parts.second),
      };
    }

    function isOpsDayToggleWindow() {
      const p = getTorontoParts();
      return p.hour >= 12 || p.hour < 3;
    }

    function initOpsDayControl() {
      const control = document.getElementById("opsDayControl");
      const select = document.getElementById("opsDaySelect");
      if (!control || !select) return;

      opsDayEnabled = isOpsDayToggleWindow();
      control.classList.toggle("hidden", !opsDayEnabled);

      if (opsDayEnabled) {
        const stored = localStorage.getItem(LS_OPS_DAY);
        opsDayMode = (stored === "next" || stored === "current") ? stored : "current";
        select.value = opsDayMode;
        select.addEventListener("change", () => {
          opsDayMode = select.value === "next" ? "next" : "current";
          localStorage.setItem(LS_OPS_DAY, opsDayMode);
          cache.clear();
          useCacheThenFetch_();
        });
      } else {
        opsDayMode = "current";
        select.value = "current";
      }
    }

    function isTyping() {
      const tag = (document.activeElement && document.activeElement.tagName) || "";
      return Date.now() < typingUntil || tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT";
    }

    function onSearchInput() { typingUntil = Date.now() + 1200; render(); }

    function setType(t) {
      filterType = t;
      document.getElementById("tALL").classList.toggle("active", t === "ALL");
      document.getElementById("tARR").classList.toggle("active", t === "ARR");
      document.getElementById("tDEP").classList.toggle("active", t === "DEP");
      useCacheThenFetch_();
    }

    function setChangeFilter(v) {
      changeFilter = v;
      document.getElementById("cALL").classList.toggle("active", v === "ALL");
      document.getElementById("cGate").classList.toggle("active", v === "GATE");
      document.getElementById("cTime").classList.toggle("active", v === "TIME");
      render();
    }

    function setZone(z) { selectedZone = z; syncZonePills_(); syncZoneDropdown_(); updateViewOnlyBanner(); useCacheThenFetch_(); }

    function onZoneDropdownChange() {
      const z = document.getElementById("zoneSel").value;
      if (!z) return;
      selectedZone = z;
      syncZonePills_();
      useCacheThenFetch_();
    }

    function syncZonePills_() {
      const map = { "TB":"zTB", "Gates":"zGates", "Pier A":"zPierA", "T1":"zT1" };
      Object.keys(map).forEach(k => {
        const el = document.getElementById(map[k]);
        if (el) {
          el.classList.toggle("active", selectedZone === k);
          el.classList.toggle("work-zone-pill", workZone === k);
        }
      });
    }
    function syncZoneDropdown_() {
      const sel = document.getElementById("zoneSel");
      if (sel && sel.value !== selectedZone) sel.value = selectedZone;
    }

    function cacheKey_(){ return `${selectedZone}__${filterType}__${opsDayMode}`; }

    function applyAckSuppression_(arr) {
      const now = Date.now();
      return (arr || []).map(r => {
        const key = String(r.key || "");
        const exp = ackSuppress.get(key);
        if (!exp) return r;
        if (now > exp) { ackSuppress.delete(key); return r; }
        return { ...r, alert:"", gateChanged:false, timeChanged:false, zoneChanged:false };
      });
    }

    function rememberPendingEdit(key, field, val) {
      if (!key || !field) return;
      pendingEdits.set(String(key), { field, val, exp: Date.now() + PENDING_EDIT_TTL_MS });
    }

    function clearPendingEdit(key, field) {
      if (!key || !field) return;
      const entry = pendingEdits.get(String(key));
      if (entry && entry.field === field) pendingEdits.delete(String(key));
    }

    function applyPendingEdits_(arr) {
      const now = Date.now();
      return (arr || []).map(r => {
        const key = String(r.key || "");
        const entry = pendingEdits.get(key);
        if (!entry) return r;
        if (now > entry.exp) { pendingEdits.delete(key); return r; }
        return { ...r, [entry.field]: entry.val };
      });
    }

    function useCacheThenFetch_() {
      const key = cacheKey_();
      const hit = cache.get(key);
      if (hit && (Date.now() - hit.ts) <= CACHE_MS) {
        rows = applyPendingEdits_(applyAckSuppression_(hit.rows));
        render();
        load(false);
      } else load(true);
    }

    async function init() {
      const token = getToken();
      if (!token) return hardRedirectToLogin();

      setErr("");
      try {
        const res = await fetch(API_BASE + "/lead/init", {
          headers: { "authorization": "Bearer " + token }
        });
        const data = await res.json();
        zonesAll = (data && data.zones) ? data.zones : ["TB","Gates","Pier A","T1","Unassigned"];
        zonesAll = zonesAll.filter(z => z !== "Unassigned");

        const sel = document.getElementById("zoneSel");
        sel.innerHTML = zonesAll.map(z => `<option value="${escapeAttr(z)}">${escapeHtml(z)}</option>`).join("");

        if (!zonesAll.includes(selectedZone)) selectedZone = zonesAll[0] || "TB";
        syncZonePills_();
        syncZoneDropdown_();

        await load(true);
        renderAgentList();
      } catch (e) {
        setErr(e && e.message ? e.message : String(e));
      }
    }

    async function load(force=false) {
      if (!force && isTyping()) return true;

      const token = getToken();
      if (!token) return hardRedirectToLogin();

      const myReq = ++requestSeq;
      setErr("");
      setLoading(true);

      const zone = selectedZone;
      const type = filterType;

      try {
        const url = new URL(API_BASE + "/lead/rows");
        url.searchParams.set("zone", zone);
        url.searchParams.set("type", type);
        url.searchParams.set("q", document.getElementById("q").value || "");
        url.searchParams.set("opsDay", opsDayMode);
        const twFrom = document.getElementById("fromTime").value || "";
        const twTo   = document.getElementById("toTime").value   || "";
        if (twFrom) url.searchParams.set("from", twFrom);
        if (twTo)   url.searchParams.set("to", twTo);

        const hdrs = { "authorization": "Bearer " + token };
        if (!force && lastETag) hdrs["if-none-match"] = lastETag;

        const res = await fetch(url.toString(), { headers: hdrs });

        // 304 Not Modified — data unchanged, skip processing
        if (res.status === 304) { setLoading(false); return true; }

        const data = await res.json();
        if (myReq !== requestSeq) return true;

        // Store ETag for next conditional poll
        const etag = res.headers.get("etag");
        if (etag) lastETag = etag;

        if (!data || !data.ok) {
          const msg = (data && data.error) || "Fetch failed";
          if (/unauthorized|expired|missing token/i.test(msg)) return hardRedirectToLogin();
          setErr(msg);
          setLoading(false);
          return false;
        }

        const incoming = data.rows || [];
        const cleaned = applyAckSuppression_(incoming);
        rows = applyPendingEdits_(cleaned);
        cache.set(cacheKey_(), { ts: Date.now(), rows: incoming });
        render();
        setLoading(false);
        return true;

      } catch (e) {
        if (myReq !== requestSeq) return true;
        const msg = (e && e.message) ? e.message : String(e);
        if (/unauthorized|expired|missing token/i.test(msg)) return hardRedirectToLogin();
        setErr(msg);
        setLoading(false);
        return false;
      }
    }

    function render() {
      updateViewOnlyBanner();
      const tb = document.querySelector("#tbl tbody");
      tb.innerHTML = "";

      const q = normalizeFlightQ(document.getElementById("q").value);

      const filtered = rows.filter(r => {
        const ftOk = (filterType === "ALL") || (String(r.type || "").toUpperCase() === filterType);
        const qOk  = !q || normalizeFlightQ(r.flight).includes(q);
        const changeOk = (changeFilter === "ALL")
          || (changeFilter === "GATE" && r.gateChanged)
          || (changeFilter === "TIME" && r.timeChanged);
        return ftOk && qOk && changeOk;
      });

      renderSummary(filtered);

      if (!filtered.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="empty" colspan="13">No flights match the current filters.</td>`;
        tb.appendChild(tr);
        return;
      }

      const ordered = filtered
        .map((r, idx) => ({
          r,
          idx,
          watch: ["1", "true", "yes"].includes(String(r.watchlist || "").toLowerCase()),
        }))
        .sort((a, b) => (Number(b.watch) - Number(a.watch)) || (a.idx - b.idx))
        .map(item => item.r);

      const ro = isReadOnly();
      ordered.forEach(r => {
        const tr = document.createElement("tr");
        if (ro) tr.classList.add("readonly-row");

        const t = String(r.type || "").toUpperCase();
        const typeClass = (t === "ARR") ? "type-arr" : (t === "DEP") ? "type-dep" : "";
        const gateClass = r.gateChanged ? "cell-gatechg" : "";
        const timeClass = r.timeChanged ? "cell-timechg" : "";

        const watchRaw = String(r.watchlist || "").toLowerCase();
        const watchChecked = watchRaw === "1" || watchRaw === "true" || watchRaw === "yes";

        tr.innerHTML = `
          <td class="watchCell"><input class="watch-toggle" type="checkbox" data-key="${escapeAttr(r.key)}" data-field="watchlist" ${watchChecked ? "checked" : ""} ${ro ? "disabled" : ""} /></td>
          <td><div><b>${escapeHtml(r.flight || "")}</b></div><div class="small">${escapeHtml(r.key || "")}</div></td>
          <td class="${typeClass}">${escapeHtml(r.type || "")}</td>
          <td class="${timeClass}">${escapeHtml(fmtTimeOnly(r.timeEst))}</td>
          <td>${escapeHtml(r.origin || "")}</td>
          <td class="${gateClass}">${escapeHtml(r.gate || "")}</td>
          <td>${escapeHtml(r.zone || "")}</td>
          <td class="num">${escapeHtml(r.wchr || "")}</td>
          <td class="num">${escapeHtml(r.wchc || "")}</td>
          <td class="alert">${escapeHtml(r.alert || "")}</td>
          <td>${renderAssignmentCell(r)}</td>
          <td>${renderPaxStepper(r)}</td>
          <td>${ro ? "" : `<button class="quiet" onclick="ack('${escapeAttr(r.key)}')">Ack</button>`}</td>
        `;

        tb.appendChild(tr);
      });

      tb.querySelectorAll("input, select").forEach(el => {
        if (el.classList.contains("pax-value")) return;
        el.addEventListener("input", onFieldInput);
        el.addEventListener("blur", onFieldBlur);
        el.addEventListener("change", onFieldChange);
      });
    }

    function renderSummary(filtered) {
      const summary = document.getElementById("summary");
      if (!summary) return;

      const total = filtered.length;
      const arr = filtered.filter(r => String(r.type || "").toUpperCase() === "ARR").length;
      const dep = filtered.filter(r => String(r.type || "").toUpperCase() === "DEP").length;
      const alerts = filtered.filter(r => String(r.alert || "").trim()).length;
      const totalWchr = filtered.reduce((acc, r) => {
        const n = Number(String(r.wchr || "").trim());
        return acc + (Number.isNaN(n) ? 0 : n);
      }, 0);
      const totalWchc = filtered.reduce((acc, r) => {
        const n = Number(String(r.wchc || "").trim());
        return acc + (Number.isNaN(n) ? 0 : n);
      }, 0);

      summary.innerHTML = `
        <div class="summaryCard">
          <div class="summaryTitle">Showing</div>
          <div class="summaryValue">${total}</div>
          <div class="summaryMeta">${arr} ARR · ${dep} DEP</div>
        </div>
        <div class="summaryCard">
          <div class="summaryTitle">Alerts</div>
          <div class="summaryValue">${alerts}</div>
          <div class="summaryMeta">Gate/Time/Zone changes</div>
        </div>
        <div class="summaryCard">
          <div class="summaryTitle">Regular WCHR</div>
          <div class="summaryValue">${totalWchr}</div>
          <div class="summaryMeta">Total WCHR needed</div>
        </div>
        <div class="summaryCard">
          <div class="summaryTitle">WCHC</div>
          <div class="summaryValue">${totalWchc}</div>
          <div class="summaryMeta">Total WCHC needed</div>
        </div>
        <div class="summaryLegend">
          <span class="legendItem gate">Gate change</span>
          <span class="legendItem time">Time change</span>
          <span class="legendItem arr">ARR</span>
          <span class="legendItem dep">DEP</span>
        </div>
      `;
    }

    function onFieldInput(e) {
      typingUntil = Date.now() + 1200;

      const el = e.target;
      if (el.type === "checkbox") return;
      const key = el.getAttribute("data-key");
      const field = el.getAttribute("data-field");
      const val = getFieldValue(el);
      if (!key || !field) return;

      const timerKey = `${key}__${field}`;
      if (saveTimers.has(timerKey)) clearTimeout(saveTimers.get(timerKey));

      saveTimers.set(timerKey, setTimeout(() => {
        saveTimers.delete(timerKey);
        saveField(key, field, val);
      }, 700));
    }

    function onFieldBlur(e) {
      const el = e.target;
      if (el.type === "checkbox") return;
      const key = el.getAttribute("data-key");
      const field = el.getAttribute("data-field");
      const val = getFieldValue(el);
      if (!key || !field) return;
      saveField(key, field, val);
    }

    function onFieldChange(e) {
      const el = e.target;
      if (!(el.type === "checkbox" || el.tagName === "SELECT")) return;
      const key = el.getAttribute("data-key");
      const field = el.getAttribute("data-field");
      const val = getFieldValue(el);
      if (!key || !field) return;
      saveField(key, field, val);
    }

    function getFieldValue(el) {
      if (!el) return "";
      if (el.type === "checkbox") return el.checked;
      return el.value;
    }

    function applyLocalFieldUpdate(key, field, val) {
      const keyStr = String(key);
      rows = rows.map(r => (String(r.key) === keyStr ? { ...r, [field]: val } : r));

      const cacheKey = cacheKey_();
      const hit = cache.get(cacheKey);
      if (hit && Array.isArray(hit.rows)) {
        const updatedRows = hit.rows.map(r => (String(r.key) === keyStr ? { ...r, [field]: val } : r));
        cache.set(cacheKey, { ts: Date.now(), rows: updatedRows });
      }

      render();
    }

    async function saveField(key, field, val) {
      const token = getToken();
      if (!token) return hardRedirectToLogin();

      setErr("");
      const payload = { key };
      payload[field] = val;
      const isWatchlist = field === "watchlist";
      let prevWatchVal = null;
      if (isWatchlist) {
        const existing = rows.find(r => String(r.key) === String(key));
        prevWatchVal = existing ? (existing.watchlist ?? "") : "";
        applyLocalFieldUpdate(key, field, val);
        rememberPendingEdit(key, field, val);
      }

      try {
        const res = await fetch(API_BASE + "/lead/update", {
          method: "PATCH",
          headers: {
            "content-type": "application/json",
            "authorization": "Bearer " + token
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!data || !data.ok) {
          setErr((data && data.error) || "Update failed");
          if (isWatchlist) {
            clearPendingEdit(key, field);
            applyLocalFieldUpdate(key, field, prevWatchVal);
            await refreshAfterAction();
          }
          return;
        }
        if (isWatchlist) clearPendingEdit(key, field);
      } catch (e) {
        setErr(e && e.message ? e.message : String(e));
        if (isWatchlist) {
          clearPendingEdit(key, field);
          applyLocalFieldUpdate(key, field, prevWatchVal);
          await refreshAfterAction();
        }
        return;
      }

      if (!isWatchlist) {
        await refreshAfterAction();
      }
    }

    async function ack(key) {
      if (!key) return;

      const token = getToken();
      if (!token) return hardRedirectToLogin();

      setErr("");

      ackSuppress.set(String(key), Date.now() + ACK_SUPPRESS_MS);
      cache.delete(cacheKey_());

      rows = rows.map(r => (String(r.key) !== String(key)) ? r : ({ ...r, alert:"", gateChanged:false, timeChanged:false, zoneChanged:false }));
      render();

      try {
        const res = await fetch(API_BASE + "/lead/ack", {
          method: "POST",
          headers: {
            "content-type": "application/json",
            "authorization": "Bearer " + token
          },
          body: JSON.stringify({ key, zone: selectedZone })
        });
        const data = await res.json();
        if (!data || !data.ok) setErr((data && data.error) || "ACK failed");
      } catch (e) {
        setErr((e && e.message) ? e.message : String(e));
      }

      await refreshAfterAction();
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function escapeAttr(s) { return escapeHtml(s).replaceAll("\n", " "); }

    /* ── Assignment Cell (chip-based with drop zone) ── */
    function renderAssignmentCell(r) {
      const key = escapeAttr(r.key);
      const raw = r.assignment || "";
      const names = raw ? raw.split(",").map(n => n.trim()).filter(Boolean) : [];
      const ro = isReadOnly();

      let chipsHtml = names.map((name, i) => {
        if (ro) return `<span class="assign-chip">${escapeHtml(name)}</span>`;
        return `<span class="assign-chip">${escapeHtml(name)}<span class="chip-x" onclick="removeAssignment('${key}', ${i})" title="Remove">&times;</span></span>`;
      }).join("");

      if (!ro) {
        chipsHtml += `<span class="assign-add-btn" onclick="promptManualAssign('${key}')" title="Add agent">+</span>`;
      }
      if (!names.length && ro) chipsHtml = `<span style="color:#aaa;font-size:12px;">—</span>`;

      if (ro) return `<div class="assign-cell">${chipsHtml}</div>`;

      return `<div class="assign-cell" data-key="${key}"
                   ondragover="onAssignDragOver(event)"
                   ondragleave="onAssignDragLeave(event)"
                   ondrop="onAssignDrop(event)">${chipsHtml}</div>`;
    }

    function removeAssignment(key, index) {
      const row = rows.find(r => String(r.key) === String(key));
      if (!row) return;
      const names = (row.assignment || "").split(",").map(n => n.trim()).filter(Boolean);
      names.splice(index, 1);
      const newVal = names.join(", ");
      applyLocalFieldUpdate(key, "assignment", newVal);
      rememberPendingEdit(key, "assignment", newVal);
      saveField(key, "assignment", newVal);
    }

    function promptManualAssign(key) {
      const name = prompt("Enter agent name:");
      if (!name || !name.trim()) return;
      const row = rows.find(r => String(r.key) === String(key));
      const current = (row && row.assignment) || "";
      const names = current ? current.split(",").map(n => n.trim()).filter(Boolean) : [];
      const trimmed = name.trim();
      if (!names.includes(trimmed)) names.push(trimmed);
      const newVal = names.join(", ");
      applyLocalFieldUpdate(key, "assignment", newVal);
      rememberPendingEdit(key, "assignment", newVal);
      saveField(key, "assignment", newVal);
    }

    /* ── Pax Stepper ─────────────────────────── */
    function renderPaxStepper(r) {
      const key = escapeAttr(r.key);
      const paxVal = parseInt(r.pax, 10) || 0;
      if (isReadOnly()) {
        return `<span style="font-weight:700;font-size:13px;">${paxVal}</span>`;
      }
      return `<div class="pax-stepper">
        <button onclick="stepPax('${key}', -1)">&minus;</button>
        <input class="pax-value" type="number" min="0"
               data-key="${key}" data-field="pax"
               value="${paxVal}"
               oninput="onPaxDirectInput(this)"
               onblur="onPaxBlur(this)" />
        <button onclick="stepPax('${key}', 1)">+</button>
      </div>`;
    }

    function stepPax(key, delta) {
      const row = rows.find(r => String(r.key) === String(key));
      if (!row) return;
      const current = parseInt(row.pax, 10) || 0;
      const newVal = Math.max(0, current + delta);
      applyLocalFieldUpdate(key, "pax", String(newVal));
      rememberPendingEdit(key, "pax", String(newVal));
      saveField(key, "pax", String(newVal));
    }

    function onPaxDirectInput(el) {
      typingUntil = Date.now() + 1200;
      const key = el.getAttribute("data-key");
      const val = el.value;
      const timerKey = `${key}__pax`;
      if (saveTimers.has(timerKey)) clearTimeout(saveTimers.get(timerKey));
      saveTimers.set(timerKey, setTimeout(() => {
        saveTimers.delete(timerKey);
        const numVal = Math.max(0, parseInt(val, 10) || 0);
        saveField(key, "pax", String(numVal));
      }, 700));
    }

    function onPaxBlur(el) {
      const key = el.getAttribute("data-key");
      const timerKey = `${key}__pax`;
      if (saveTimers.has(timerKey)) { clearTimeout(saveTimers.get(timerKey)); saveTimers.delete(timerKey); }
      const val = Math.max(0, parseInt(el.value, 10) || 0);
      saveField(key, "pax", String(val));
    }

    /* ── Drag & Drop ─────────────────────────── */
    let draggedAgent = null;

    function onAgentDragStart(event, agentName) {
      draggedAgent = agentName;
      event.dataTransfer.setData("text/plain", agentName);
      event.dataTransfer.effectAllowed = "copy";
      document.querySelectorAll(".assign-cell").forEach(el => {
        el.style.outline = "1px dashed #bbb";
      });
    }

    function onAgentDragEnd(event) {
      draggedAgent = null;
      document.querySelectorAll(".assign-cell").forEach(el => {
        el.classList.remove("drag-over");
        el.style.outline = "";
      });
    }

    function onAssignDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = "copy";
      event.currentTarget.classList.add("drag-over");
    }

    function onAssignDragLeave(event) {
      event.currentTarget.classList.remove("drag-over");
    }

    function onAssignDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove("drag-over");
      if (isReadOnly()) return; // Can't drop in read-only zone
      const agentName = event.dataTransfer.getData("text/plain") || draggedAgent;
      if (!agentName) return;
      const key = event.currentTarget.getAttribute("data-key");
      if (!key) return;
      const row = rows.find(r => String(r.key) === String(key));
      const currentAssignment = (row && row.assignment) || "";
      const names = currentAssignment ? currentAssignment.split(",").map(n => n.trim()).filter(Boolean) : [];
      if (names.includes(agentName)) return;
      names.push(agentName);
      const newVal = names.join(", ");
      applyLocalFieldUpdate(key, "assignment", newVal);
      rememberPendingEdit(key, "assignment", newVal);
      saveField(key, "assignment", newVal);
    }

    /* ── Touch Drag-Drop (iPad / touch devices) ── */
    let touchDragGhost = null;
    let touchDragAgent = null;
    let touchDragOver  = null;   // currently hovered .assign-cell
    let touchAutoScrollRAF = null;

    function onAgentTouchStart(e, agentName) {
      // Only single-finger touch
      if (e.touches.length !== 1) return;
      e.preventDefault();   // prevent scroll while starting drag

      touchDragAgent = agentName;

      // Create ghost element
      touchDragGhost = document.createElement("div");
      touchDragGhost.className = "touch-drag-ghost";
      touchDragGhost.textContent = agentName;
      document.body.appendChild(touchDragGhost);

      const t = e.touches[0];
      touchDragGhost.style.left = t.clientX + "px";
      touchDragGhost.style.top  = t.clientY + "px";

      // Highlight all drop zones
      document.querySelectorAll(".assign-cell").forEach(el => {
        el.style.outline = "1px dashed #bbb";
      });

      // Start auto-scroll loop
      startTouchAutoScroll();
    }

    function onDocumentTouchMove(e) {
      if (!touchDragAgent || !touchDragGhost) return;
      e.preventDefault();

      const t = e.touches[0];
      touchDragGhost.style.left = t.clientX + "px";
      touchDragGhost.style.top  = t.clientY + "px";

      // Temporarily hide ghost so elementFromPoint sees the cell beneath
      touchDragGhost.style.display = "none";
      const elUnder = document.elementFromPoint(t.clientX, t.clientY);
      touchDragGhost.style.display = "";

      // Find the closest .assign-cell ancestor
      const cell = elUnder ? elUnder.closest(".assign-cell") : null;

      if (touchDragOver && touchDragOver !== cell) {
        touchDragOver.classList.remove("drag-over");
      }
      if (cell) {
        cell.classList.add("drag-over");
      }
      touchDragOver = cell;

      // Store last touch position for auto-scroll
      window._lastTouchY = t.clientY;
    }

    function onDocumentTouchEnd(e) {
      if (!touchDragAgent) return;

      stopTouchAutoScroll();

      // Determine drop target (ignore if read-only zone)
      if (touchDragOver && !isReadOnly()) {
        touchDragOver.classList.remove("drag-over");
        const key = touchDragOver.getAttribute("data-key");
        if (key && touchDragAgent) {
          const row = rows.find(r => String(r.key) === String(key));
          const currentAssignment = (row && row.assignment) || "";
          const names = currentAssignment ? currentAssignment.split(",").map(n => n.trim()).filter(Boolean) : [];
          if (!names.includes(touchDragAgent)) {
            names.push(touchDragAgent);
            const newVal = names.join(", ");
            applyLocalFieldUpdate(key, "assignment", newVal);
            rememberPendingEdit(key, "assignment", newVal);
            saveField(key, "assignment", newVal);
          }
        }
      }

      // Cleanup
      if (touchDragGhost) { touchDragGhost.remove(); touchDragGhost = null; }
      touchDragAgent = null;
      touchDragOver = null;
      document.querySelectorAll(".assign-cell").forEach(el => {
        el.classList.remove("drag-over");
        el.style.outline = "";
      });
    }

    // Auto-scroll the table when dragging near the edges
    function startTouchAutoScroll() {
      const tableWrap = document.querySelector(".tableWrap");
      if (!tableWrap) return;

      function scrollLoop() {
        const y = window._lastTouchY;
        if (y == null) { touchAutoScrollRAF = requestAnimationFrame(scrollLoop); return; }

        const rect = tableWrap.getBoundingClientRect();
        const edgeZone = 60;

        if (y > rect.bottom - edgeZone && y < rect.bottom + 20) {
          tableWrap.scrollTop += 6;
        } else if (y < rect.top + edgeZone && y > rect.top - 20) {
          tableWrap.scrollTop -= 6;
        }
        touchAutoScrollRAF = requestAnimationFrame(scrollLoop);
      }
      touchAutoScrollRAF = requestAnimationFrame(scrollLoop);
    }

    function stopTouchAutoScroll() {
      if (touchAutoScrollRAF) { cancelAnimationFrame(touchAutoScrollRAF); touchAutoScrollRAF = null; }
      window._lastTouchY = null;
    }

    // Attach global touch handlers once
    document.addEventListener("touchmove", onDocumentTouchMove, { passive: false });
    document.addEventListener("touchend", onDocumentTouchEnd);
    document.addEventListener("touchcancel", onDocumentTouchEnd);

    /* ── Agent Sidebar Management ─────────────── */
    function agentKey_() {
      const z = (workZone || "TB").replace(/\s+/g, "");
      return "PRM_AGENTS_" + z;
    }

    function getAgents() {
      try { return JSON.parse(localStorage.getItem(agentKey_())) || []; }
      catch { return []; }
    }

    function saveAgents(list) { localStorage.setItem(agentKey_(), JSON.stringify(list)); }

    function renderAgentList() {
      const container = document.getElementById("agentList");
      if (!container) return;
      const list = getAgents();
      container.innerHTML = list.map((name, i) =>
        `<div class="agent-tag" draggable="true"
              ondragstart="onAgentDragStart(event, '${escapeAttr(name)}')"
              ondragend="onAgentDragEnd(event)"
              ontouchstart="onAgentTouchStart(event, '${escapeAttr(name)}')">
          <span>${escapeHtml(name)}</span>
          <span class="remove-agent" onclick="removeAgent(${i})" title="Remove">&times;</span>
        </div>`
      ).join("");
    }

    function addAgent() {
      const input = document.getElementById("agentInput");
      const name = (input.value || "").trim();
      if (!name) return;
      const list = getAgents();
      if (list.includes(name)) { input.value = ""; return; }
      list.push(name);
      saveAgents(list);
      input.value = "";
      renderAgentList();
    }

    function removeAgent(index) {
      const list = getAgents();
      list.splice(index, 1);
      saveAgents(list);
      renderAgentList();
    }

    function toggleSidebar() {
      const sidebar = document.getElementById("agentSidebar");
      const btn = sidebar.querySelector(".sidebar-toggle");
      sidebar.classList.toggle("collapsed");
      btn.innerHTML = sidebar.classList.contains("collapsed") ? "&raquo;" : "&laquo;";
    }

    function onTimeWindowChange() {
      cache.clear();
      useCacheThenFetch_();
    }

    function clearTimeWindow() {
      document.getElementById("fromTime").value = "";
      document.getElementById("toTime").value   = "";
      cache.clear();
      useCacheThenFetch_();
    }

    // Update sidebar title with zone name
    function updateSidebarTitle() {
      const el = document.getElementById("sidebarTitle");
      if (el) el.textContent = workZone ? ("Agents — " + workZone) : "Agents";
    }

    initOpsDayControl();
    updateWorkZoneBadge();
    updateSidebarTitle();

    if (!workZone) {
      // Show zone picker first. pickWorkZone handles setting workZone + calling auth.
      showZonePicker();
    } else {
      selectedZone = workZone;
      syncZonePills_();
      validateAuthThenInit();
    }
  </script>
</body>
</html>
